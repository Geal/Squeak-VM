#!/usr/bin/make -f
# A debian/rules file for the Squeak VM and for inisqueak.  This
# is based on a sample debian/rules file from debhelper,
# which is GNU copyright 1997 by Joey Hess.

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=3


# This is the Squeak version we are compiling
# It is only available once configure has been run!
version=$(shell if [ -f  build-oss/version ]; then cat build-oss/version; else echo noversionyet; fi)

configure: configure-stamp
configure-stamp:
	dh_testdir
	mkdir build-oss
	(cd build-oss; ../platforms/unix/misc/configure --prefix=/usr --with-audio=oss)
	mkdir build-nas
	(cd build-nas; ../platforms/unix/misc/configure --prefix=/usr --with-audio=nas)
	touch configure-stamp

build: build-stamp
build-stamp: configure-stamp 
	dh_testdir
	(cd build-oss; $(MAKE) squeak squeak.1 inisqueak.1)
	(cd build-nas; $(MAKE) squeak squeak.1)
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp
	rm -rf build-oss build-nas
	dh_clean -a
	rm -rf debian/squeak-vm-nas debian/squeak-vm-oss debian/inisqueak


install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdocs -a -i

	$(foreach audio, oss nas, \
		install -d $(CURDIR)/debian/squeak-vm-$(audio)/usr/bin; \
		install -m 755 build-$(audio)/squeak $(CURDIR)/debian/squeak-vm-$(audio)/usr/bin/squeak ; \
		\
		install -d $(CURDIR)/debian/squeak-vm-$(audio)/usr/lib/squeak/$(version) ; \
		install -m 644 build-$(audio)/squeak.map $(CURDIR)/debian/squeak-vm-$(audio)/usr/lib/squeak/$(version) ; \
		dh_installman -psqueak-vm-$(audio)  build-$(audio)/squeak.1 ; \
	)


	install -d $(CURDIR)/debian/inisqueak/usr/bin
	install -m 755 build-oss/inisqueak $(CURDIR)/debian/inisqueak/usr/bin/

	dh_installman -pinisqueak build-oss/inisqueak.1

#	dh_movefiles


binary-indep: build install
	dh_testdir -i
	dh_testroot -i
#	dh_installdebconf -i
	dh_installdocs -i
#	dh_installexamples -i
	dh_installmenu -i
#	dh_installlogrotate -i
#	dh_installemacsen -i
#	dh_installpam -i
#	dh_installmime -i
#	dh_installinit -i
#	dh_installcron -i
#	dh_installman -i build-oss/squeak.1
#	ln -s squeak.1 $(DESTDIR)/usr/share/man/inisqueak.1
#	dh_installinfo -i
#	dh_undocumented -i
	dh_installchangelogs  -i
#	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
#	dh_perl -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i


binary-arch: build install
	dh_testdir -a
	dh_testroot -a
#	dh_installdebconf -a
	dh_installdocs -a
#	dh_installexamples -a
	dh_installmenu -a
#	dh_installlogrotate -a
#	dh_installemacsen -a
#	dh_installpam -a
#	dh_installmime -a
#	dh_installinit -a
#	dh_installcron -a
	dh_installman -a build-oss/squeak.1
#	ln -s squeak.1 $(CURDIR)/debian/usr/share/man/inisqueak.1
#	dh_installinfo -a
#	dh_undocumented -a
	dh_installchangelogs  -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
#	dh_makeshlibs -a
	dh_installdeb -a
#	dh_perl -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
