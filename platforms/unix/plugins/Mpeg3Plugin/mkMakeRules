#!/bin/sh
# generate make rules for Mpeg3Plugin on Unix
#
# Arguments:
#   1   the combined "src" directory, just underneath
#       the top of the VMMaker layout
#   2   optionally, the word "internal" to indicate
#       an internal plugin
#


# set $mode depending on whether compilation should be internal or external
if [ "x$2" = "xinternal" ]
then
   mode=internal
else
   mode=external
fi

# set plugsubdir to the plugins directory that Mpeg3Plugin is located in;
# it is in different places depending on whether it is compiled
# internally or externally
if [ $mode = internal ]
then
   plugsubdir=vm/intplugins
else
   plugsubdir=plugins
fi


# names for frequently-used directories
topdir=$1
srcdir=$topdir/src
crossdir=$topdir/platforms/Cross
libmpegdir=$crossdir/plugins/Mpeg3Plugin/libmpeg





echo "#### automatically generated by $0"




cat <<EOF
Mpeg3Plugin_DIR=\$(topdir)/src/$plugsubdir/Mpeg3Plugin
EOF




cat <<EOF

### Rules for building libmpeg3
EOF



if [ $mode = external ]
then
cat <<EOF
LIBMPEG_CC:=\$(LIBTOOL) --mode=compile \$(CC)
LIBMPEG_LINKLIB:=\$(LIBTOOL) --mode=link \$(CC) -o
LIBMPEG_OBJECT_EXT:=lo
LIBMPEG_LIBRARY_EXT:=la
EOF
else
cat <<EOF
LIBMPEG_CC:=\$(CC)
LIBMPEG_LINKLIB:=\$(AR) rcs
LIBMPEG_OBJECT_EXT:=o
LIBMPEG_LIBRARY_EXT:=a
EOF
fi


cat <<EOF
LIBMPEG_CFLAGS:=-O3
LIBMPEG_NASM:=nasm -f elf
LIBMPEG_SOURCE_DIR:=$libmpegdir
LIBMPEG_BUILD_DIR:=\$(top_builddir)/Mpeg3Plugin/libmpeg
EOF



cat $libmpegdir/make.inc



if [ $mode = external ]
then
#rules for compile externally
cat <<EOF
Mpeg3Plugin.lo : \$(Mpeg3Plugin_DIR)/Mpeg3Plugin.c
	\$(LTCOMPILE)  -I\$(Mpeg3Plugin_DIR) -I\$(LIBMPEG_SOURCE_DIR) -I\$(LIBMPEG_SOURCE_DIR)/audio -I\$(LIBMPEG_SOURCE_DIR)/video -I$crossdir/plugins/Mpeg3Plugin -c \$(Mpeg3Plugin_DIR)/Mpeg3Plugin.c -o Mpeg3Plugin.lo

Mpeg3Plugin.la : Mpeg3Plugin.lo \$(LIBMPEG_BUILD_DIR)/libmpeg3.la
	\$(LINK) Mpeg3Plugin -module -rpath \$(sqlibdir) -o Mpeg3Plugin.la Mpeg3Plugin.lo \$(LIBMPEG_BUILD_DIR)/libmpeg3.la


EOF

else
#rules for compiling internally 
cat <<EOF
Mpeg3Plugin.o : \$(Mpeg3Plugin_DIR)/Mpeg3Plugin.c
	\$(COMPILE) -I\$(Mpeg3Plugin_DIR) -I\$(LIBMPEG_SOURCE_DIR) -I\$(LIBMPEG_SOURCE_DIR)/audio -I\$(LIBMPEG_SOURCE_DIR)/video -I$crossdir/plugins/Mpeg3Plugin -c \$(Mpeg3Plugin_DIR)/Mpeg3Plugin.c -o Mpeg3Plugin.o


PLUGINS_O:=\$(PLUGINS_O) Mpeg3Plugin.o \$(LIBMPEG_BUILD_DIR)/libmpeg3.a

EOF
fi



echo "#### end of rules generated by $0"
